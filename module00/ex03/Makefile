# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# โ ๐ Piscine embedded									              โ
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

NAME        = main

SRCDIR      = src
OBJDIR      = obj
INCDIR      = include
BINDIR      = bin
HEXDIR      = hex

SRC         = main.c
OBJ         = $(addprefix $(OBJDIR)/,$(SRC:.c=.o))

BIN         = $(BINDIR)/$(NAME).bin
HEX         = $(HEXDIR)/$(NAME).hex


# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# โ โจ AVR Configuration โจ									        โ
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

MCU         = atmega328p
F_CPU       = 16000000UL


# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# โ ๐ง Tools 						                                  โ
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

CC          = avr-gcc
OBJCOPY     = avr-objcopy

CFLAGS      = -mmcu=$(MCU) -DF_CPU=$(F_CPU) -Os -I$(INCDIR)

PROGRAMMER  = arduino
BAUD        = 115200
PORT        = /dev/ttyUSB0
AVRDUDE     = avrdude -c $(PROGRAMMER) -p $(MCU) -P $(PORT) -b $(BAUD)


# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# โ ๐ฐ๏ธ Build System 							                       โ
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

VERBOSE ?= 0
ifeq ($(VERBOSE),1)
    V :=
else
    V := @
endif

DEP = $(OBJ:.o=.d)


# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# โ ๐ง Rules						                                  โ
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

all: $(HEX) flash

$(OBJDIR)/%.o: $(SRCDIR)/%.c | $(OBJDIR)
	$(V)mkdir -p $(dir $@)
	$(V)$(CC) $(CFLAGS) -MMD -MP -c $< -o $@

$(BIN): $(OBJ) | $(BINDIR)
	$(V)$(CC) $(CFLAGS) -o $(BIN) $(OBJ)

$(HEX): $(BIN) | $(HEXDIR)
	$(V)$(OBJCOPY) -O ihex $(BIN) $(HEX)

flash: $(HEX)
	$(V)$(AVRDUDE) -U flash:w:$(HEX)

$(OBJDIR):
	$(V)mkdir -p $(OBJDIR)

$(BINDIR):
	$(V)mkdir -p $(BINDIR)

$(HEXDIR):
	$(V)mkdir -p $(HEXDIR)


# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# โ ๐งน Maintenance 						                              โ
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

clean:
	$(V)rm -rf $(BINDIR) $(HEXDIR)

fclean: clean
	$(V)rm -rf $(OBJDIR)
	$(V)rm -f $(BIN) $(HEX)

re: fclean all


# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# โ ๐ Dependencies 									              โ
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

-include $(DEP)


# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# โ ๐ Autre 				                                          โ
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

.PHONY: all clean fclean re flash
.DEFAULT_GOAL := all
